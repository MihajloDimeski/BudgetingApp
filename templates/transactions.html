{% extends "base.html" %}

{% block content %}
<div class="dashboard-grid" style="grid-template-columns: 1fr 2fr;">
    <div class="card">
        {% if edit_transaction %}
        <div class="card-header">Edit Transaction</div>
        {% else %}
        <div class="card-header">Add Transaction</div>

        <div class="tabs" style="margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div class="tab active" onclick="showForm('one-time')"
                style="padding: 0.5rem; cursor: pointer; color: var(--text-primary);">One-Time</div>
            <div class="tab" onclick="showForm('recurring')"
                style="padding: 0.5rem; cursor: pointer; color: var(--text-secondary);">Recurring</div>
        </div>
        {% endif %}

        <form id="one-time-form"
            action="{{ url_for('update_transaction', id=edit_transaction.id) if edit_transaction else url_for('transactions') }}"
            method="POST">
            <div class="form-group">
                <label>Amount</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="number" step="0.01" name="amount" class="form-control" required placeholder="0.00"
                        style="flex: 2;" value="{{ edit_transaction.amount if edit_transaction else '' }}">
                    <select name="currency" class="form-control" style="flex: 1;">
                        <option value="USD" {% if current_user.household.base_currency=='USD' %}selected{% endif %}>USD
                        </option>
                        <option value="EUR" {% if current_user.household.base_currency=='EUR' %}selected{% endif %}>EUR
                        </option>
                        <option value="MKD" {% if current_user.household.base_currency=='MKD' %}selected{% endif %}>MKD
                        </option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <input type="text" name="description" class="form-control" required placeholder="e.g. Groceries"
                    value="{{ edit_transaction.description if edit_transaction else '' }}">
            </div>

            <div class="form-group">
                <label>Type</label>
                <select name="type" id="type-select" class="form-control" onchange="toggleIntegration()">
                    <option value="expense" {% if edit_transaction and edit_transaction.type=='expense' %}selected{%
                        endif %}>Expense</option>
                    <option value="income" {% if edit_transaction and edit_transaction.type=='income' %}selected{% endif
                        %}>Income</option>
                    <option value="investment" {% if edit_transaction and edit_transaction.type=='investment'
                        %}selected{% endif %}>Investment</option>
                </select>
            </div>

            <div class="form-group" id="integration-group" style="display: none;">
                <label>Target Integration (for Investment)</label>
                <select name="integration_id" class="form-control">
                    <option value="">-- Select Integration --</option>
                    {% for i in integrations %}
                    <option value="{{ i.id }}">{{ i.platform|capitalize }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Category (Optional)</label>
                <select name="category_id" class="form-control">
                    <option value="">-- No Category --</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}" {% if edit_transaction and edit_transaction.category_id==cat.id
                        %}selected{% endif %}>{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group" id="income-source-group">
                <label id="income-source-label">Funded By (Optional)</label>
                <select name="income_source_id" class="form-control">
                    <option value="">-- General Fund / None --</option>
                    {% for inc in income_sources %}
                    <option value="{{ inc.id }}" {% if edit_transaction and edit_transaction.income_source_id==inc.id
                        %}selected{% endif %}>{{ inc.description }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Date</label>
                <input type="date" name="date" class="form-control"
                    value="{{ edit_transaction.date.strftime('%Y-%m-%d') if edit_transaction else today }}">
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%;">{{ 'Update Transaction' if
                edit_transaction else 'Add Transaction' }}</button>
            {% if edit_transaction %}
            <a href="{{ url_for('transactions') }}" class="btn btn-secondary"
                style="width: 100%; margin-top: 0.5rem; text-align: center; display: block; background: var(--text-secondary); color: var(--bg-primary);">Cancel</a>
            {% endif %}
        </form>

        <form id="recurring-form" action="{{ url_for('add_recurring') }}" method="POST" class="hidden"
            style="display: none;">
            <div class="form-group">
                <label>Amount</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="number" step="0.01" name="amount" class="form-control" required placeholder="0.00"
                        style="flex: 2;">
                    <select name="currency" class="form-control" style="flex: 1;">
                        <option value="USD" {% if current_user.household.base_currency=='USD' %}selected{% endif %}>USD
                        </option>
                        <option value="EUR" {% if current_user.household.base_currency=='EUR' %}selected{% endif %}>EUR
                        </option>
                        <option value="MKD" {% if current_user.household.base_currency=='MKD' %}selected{% endif %}>MKD
                        </option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Description</label>
                <input type="text" name="description" class="form-control" required placeholder="e.g. Netflix">
            </div>

            <div class="form-group">
                <label>Type</label>
                <select name="type" class="form-control">
                    <option value="expense">Expense</option>
                    <option value="income">Income</option>
                </select>
            </div>

            <div class="form-group">
                <label>Category (Optional)</label>
                <select name="category_id" class="form-control">
                    <option value="">-- No Category --</option>
                    {% for cat in categories %}
                    <option value="{{ cat.id }}">{{ cat.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Frequency</label>
                <select name="frequency" class="form-control">
                    <option value="monthly">Monthly</option>
                    <option value="weekly">Weekly</option>
                    <option value="yearly">Yearly</option>
                </select>
            </div>

            <div class="form-group">
                <label>Next Due Date</label>
                <input type="date" name="next_due_date" class="form-control" required>
            </div>

            <button type="submit" class="btn btn-success" style="width: 100%;">Set Recurring</button>
        </form>
    </div>

    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <div class="card-header" style="margin-bottom: 0;">Transaction History</div>
            <div class="month-nav"
                style="background: var(--bg-primary); padding: 0.2rem 0.5rem; border-radius: 20px; font-size: 0.8rem; display: flex; gap: 0.5rem; align-items: center;">
                <a href="{{ url_for('transactions', month=prev_month, year=prev_year) }}"
                    style="color: var(--text-primary); text-decoration: none;">&lt;</a>
                <span style="font-weight: 600;">{{ month_name }} {{ year }}</span>
                <a href="{{ url_for('transactions', month=next_month, year=next_year) }}"
                    style="color: var(--text-primary); text-decoration: none;">&gt;</a>
            </div>
        </div>

        <table class="table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Funded By</th>
                    <th style="text-align: right;">Amount</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for t in transactions %}
                <tr>
                    <td>{{ t.date.strftime('%Y-%m-%d') }}</td>
                    <td>{{ t.description }}</td>
                    <td>{{ t.category.name if t.category else '-' }}</td>
                    <td>
                        {% if t.income_source %}
                        <span
                            style="font-size: 0.8rem; background: var(--bg-primary); padding: 2px 6px; border-radius: 4px;">{{
                            t.income_source.description }}</span>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                    <td
                        style="color: {% if t.type == 'income' %}var(--success-color){% elif t.type == 'investment' %}var(--accent-color){% else %}var(--danger-color){% endif %}; font-weight: bold;">
                        {{ '+' if t.type == 'income' or t.type == 'investment' else '-' }}{{ currency_symbol(t.currency)
                        }}{{
                        "%.2f"|format(t.amount) }}
                    </td>
                    <td>
                        <a href="{{ url_for('edit_transaction', id=t.id) }}"
                            style="color: var(--accent-color); text-decoration: none; margin-right: 0.5rem;"
                            title="Edit">&#9998;</a>
                        <a href="{{ url_for('delete_transaction', id=t.id) }}"
                            style="color: var(--text-secondary); text-decoration: none;"
                            onclick="return confirm('Delete transaction?')">&times;</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; color: var(--text-secondary);">No transactions found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div style="margin-top: 2rem;">
            <div class="card-header">Active Recurring</div>
            <table>
                <thead>
                    <tr>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Frequency</th>
                        <th>Next Due</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in recurring %}
                    <tr>
                        <td>{{ r.description }}</td>
                        <td>{{ r.category.name if r.category else '-' }}</td>
                        <td
                            style="color: {% if r.type == 'income' %}var(--success-color){% else %}var(--danger-color){% endif %}; font-weight: bold;">
                            {{ '+' if r.type == 'income' else '-' }}{{ currency_symbol(r.currency) }}{{
                            "%.2f"|format(r.amount) }}
                        </td>
                        <td>{{ r.frequency|capitalize }}</td>
                        <td>{{ r.next_due_date.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <a href="{{ url_for('delete_recurring', id=r.id) }}"
                                style="color: var(--danger-color);">Stop</a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--text-secondary);">No recurring
                            transactions.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    function showForm(formName) {
        if (formName === 'one-time') {
            document.getElementById('one-time-form').style.display = 'block';
            document.getElementById('recurring-form').style.display = 'none';
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.querySelectorAll('.tab')[1].classList.remove('active');
        } else {
            document.getElementById('one-time-form').style.display = 'none';
            document.getElementById('recurring-form').style.display = 'block';
            document.querySelectorAll('.tab')[0].classList.remove('active');
            document.querySelectorAll('.tab')[1].classList.add('active');
        }
    }

    function toggleIntegration() {
        const type = document.getElementById('type-select').value;
        const group = document.getElementById('integration-group');
        const sourceLabel = document.getElementById('income-source-label');

        if (type === 'investment') {
            group.style.display = 'block';
            sourceLabel.innerText = "Funded By (Optional)";
        } else if (type === 'income') {
            group.style.display = 'none';
            group.querySelector('select').value = ""; // reset
            sourceLabel.innerText = "Add to Source (Optional - Top up)";
        } else {
            group.style.display = 'none';
            group.querySelector('select').value = ""; // reset
            sourceLabel.innerText = "Funded By (Optional)";
        }
    }

    // Call on load to set initial state
    document.addEventListener("DOMContentLoaded", function () {
        toggleIntegration();
    });
</script>
{% endblock %}